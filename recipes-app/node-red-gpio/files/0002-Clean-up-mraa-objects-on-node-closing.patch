From 3582fc9cb09adedce0cb39acb3daf7adcdba2918 Mon Sep 17 00:00:00 2001
From: Ivan Mikhaylov <ivan.mikhaylov@siemens.com>
Date: Wed, 27 Jul 2022 18:35:58 -0400
Subject: [PATCH 2/3] Clean up mraa objects on node closing

Required as nodejs will only lazily delete the node objects, and we may
race with the next user requesting the resources.

Signed-off-by: Jan Kiszka <jan.kiszka@siemens.com>
Signed-off-by: Ivan Mikhaylov <ivan.mikhaylov@siemens.com>
---
 hardware/intel/mraa-gpio-ain.js  | 1 +
 hardware/intel/mraa-gpio-dout.js | 1 +
 hardware/intel/mraa-gpio-led.js  | 4 ++++
 hardware/intel/mraa-gpio-pwm.js  | 1 +
 4 files changed, 7 insertions(+)

diff --git a/hardware/intel/mraa-gpio-ain.js b/hardware/intel/mraa-gpio-ain.js
index 65df93b..91e2b0b 100644
--- a/hardware/intel/mraa-gpio-ain.js
+++ b/hardware/intel/mraa-gpio-ain.js
@@ -22,6 +22,7 @@ module.exports = function(RED) {
 
         this.on('close', function() {
             clearInterval(this.timer);
+            node.x.close();
         });
     }
     RED.nodes.registerType("mraa-gpio-ain", gpioAin);
diff --git a/hardware/intel/mraa-gpio-dout.js b/hardware/intel/mraa-gpio-dout.js
index 020db55..6bb833d 100644
--- a/hardware/intel/mraa-gpio-dout.js
+++ b/hardware/intel/mraa-gpio-dout.js
@@ -29,6 +29,7 @@ module.exports = function(RED) {
         });
 
         this.on('close', function() {
+            node.p.close();
         });
     }
     RED.nodes.registerType("mraa-gpio-dout", gpioDout);
diff --git a/hardware/intel/mraa-gpio-led.js b/hardware/intel/mraa-gpio-led.js
index c5e45c6..d809c64 100644
--- a/hardware/intel/mraa-gpio-led.js
+++ b/hardware/intel/mraa-gpio-led.js
@@ -64,6 +64,10 @@ module.exports = function(RED) {
             }
         });
         this.on('close', function() {
+            this.led0.close();
+            this.led1.close();
+            this.led2.close();
+            this.led3.close();
         });
     }
     RED.nodes.registerType("mraa-gpio-led", LEDNode);
diff --git a/hardware/intel/mraa-gpio-pwm.js b/hardware/intel/mraa-gpio-pwm.js
index 22b02cb..6a2469f 100644
--- a/hardware/intel/mraa-gpio-pwm.js
+++ b/hardware/intel/mraa-gpio-pwm.js
@@ -21,6 +21,7 @@ module.exports = function(RED) {
 
         this.on('close', function() {
             node.p.enable(false);
+            node.p.close();
         });
     }
     RED.nodes.registerType("mraa-gpio-pwm", gpioPWM);
-- 
2.31.1

